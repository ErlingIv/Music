<!doctype html>
<meta charset="utf-8">
<title>Composers</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:1100px;margin:2rem auto;padding:0 1rem;line-height:1.45}
  header{display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap}
  h1{margin:.2rem 0}
  .muted{color:#666}
  .msg{padding:1rem;border:1px solid #e0e0e0;border-radius:10px;background:#fafafa}
  .composer{margin:1rem 0 1.25rem;border-top:1px solid #eee;padding-top:.9rem}
  .composer h3{margin:.2rem 0 .2rem;font-size:1.15rem}
  .composer h3 a{color:inherit;text-decoration:none;border-bottom:1px dashed #999}
  .composer h3 a:hover{text-decoration:underline}
  ul.works{padding-left:1.25rem;margin:.4rem 0}
  li.work{margin:.35rem 0}
  nav.alpha{margin-top:.5rem}
  nav.alpha a{margin-right:.35rem;text-decoration:none;border:1px solid #e1e1e1;border-radius:8px;padding:.1rem .4rem;color:inherit}
  nav.alpha a.active{border-color:#0b5fff}
</style>

<header>
  <div>
    <h1 id="title">Composers</h1>
    <div class="muted" id="subtitle"></div>
  </div>
  <nav class="alpha" id="alpha"></nav>
</header>

<div id="out" class="msg">Loading…</div>
<div id="host"></div>

<script>
const LETTERS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Æ","Ø","Å"];
const collator = new Intl.Collator("nb",{sensitivity:"base"});

const params = new URLSearchParams(location.search);
let L = params.get("L") || "A"; // default A
if(!LETTERS.includes(L)) L = "A";
document.getElementById("title").textContent = `Composers — ${L}`;
document.getElementById("subtitle").textContent = "Sorted by surname (A–Å). Click a composer or work to open links.";

// alpha nav
document.getElementById('alpha').innerHTML = LETTERS.map(ch =>
  `<a class="${ch===L?'active':''}" href="?L=${encodeURIComponent(ch)}">${ch}</a>`).join(' ');

const OUT = document.getElementById('out');
const HOST = document.getElementById('host');

function safe(v){ return v==null ? "" : String(v); }
function lifeSpan(b,d){
  const B=safe(b).trim(), D=safe(d).trim();
  if(!B && !D) return "";
  if(B && D) return `${B}–${D}`;
  return B ? `${B}–` : `–${D}`;
}
function surname(name){
  let n = safe(name).trim();
  if(n.includes(",")) n = n.split(",")[0].trim();
  const parts = n.split(/\s+/);
  return parts[parts.length-1] || n;
}

// normalize your JSON (letter buckets) to a list of {name, life, url, works:[{title,year,lyricist,notes,workUrl}]}
function normalize(json, letter){
  const list = [];
  // your shape: { "A":[{ name, birth, death, url, works:[...] }], ... }
  if (json && typeof json === "object" && Array.isArray(json[letter])) {
    for (const c of json[letter]) {
      const name = safe(c.name || c.composer || c.navn || c["full name"]);
      if(!name) continue;
      const life = safe(c.life || lifeSpan(c.birth, c.death));
      const url  = safe(c.url || "");
      const works = Array.isArray(c.works) ? c.works : [];
      const outWorks = [];
      for (const w of works) {
        const title = safe(w.title || w.work || w.tittel || w.verk);
        if(!title) continue;
        const year  = safe(w.year || w.published || w["composition year"]);
        const lyr   = safe(w.lyr || w.lyricist || w.tekstforfatter || w.lyrics);
        const lyrYears = lifeSpan(w.lb, w.ld);
        const lyricist = lyr ? (lyrYears ? `${lyr} (${lyrYears})` : lyr) : "";
        outWorks.push({
          title, year, lyricist,
          notes: safe(w.comments || w.notes || ""),
          workUrl: safe(w.url || w.link || "")
        });
      }
      list.push({ name, life, url, works: outWorks });
    }
  }
  return list;
}

fetch('data/composers.json?nocache='+Date.now(), {cache:'no-store'})
  .then(async r=>{
    if(!r.ok) throw new Error("HTTP " + r.status);
    const t = await r.text();
    return JSON.parse(t.replace(/^\uFEFF/,''));
  })
  .then(json=>{
    const comps = normalize(json, L);
    if (!comps.length) {
      OUT.className="msg";
      OUT.innerHTML = `No composers found for letter <strong>${L}</strong>.`;
      return;
    }

    // sort composers by surname, then full name
    comps.sort((a,b)=>{
      const sa = surname(a.name), sb = surname(b.name);
      const s = collator.compare(sa, sb);
      return s || collator.compare(a.name, b.name);
    });

    // sort each composer's works by year, then title
    comps.forEach(c=>{
      c.works.sort((x,y)=>{
        const ax = parseInt(x.year)||0, ay = parseInt(y.year)||0;
        if (ax !== ay) return ax - ay;
        return collator.compare(x.title, y.title);
      });
    });

    OUT.textContent = ""; // clear "Loading…"

    HOST.innerHTML = comps.map(c=>{
      const life = c.life ? ` <span class="muted">— ${c.life}</span>` : "";
      const nameHTML = c.url ? `<a href="${c.url}" target="_blank" rel="noopener">${c.name}</a>` : c.name;
      const worksHTML = c.works.map(w=>{
        const yr = w.year ? ` (${w.year})` : "";
        const titleHTML = w.workUrl
          ? `<a href="${w.workUrl}" target="_blank" rel="noopener"><strong>${w.title}</strong></a>`
          : `<strong>${w.title}</strong>`;
        const lyr = w.lyricist ? `<div class="muted">Lyricist: ${w.lyricist}</div>` : "";
        const notes = w.notes ? `<div class="muted">${w.notes}</div>` : "";
        return `<li class="work">${titleHTML}${yr}${lyr}${notes}</li>`;
      }).join("");
      return `<article class="composer">
        <h3>${nameHTML}${life}</h3>
        <ul class="works">${worksHTML}</ul>
      </article>`;
    }).join("");
  })
  .catch(err=>{
    OUT.className="msg";
    OUT.innerHTML = `Error loading <code>data/composers.json</code>: ${err.message}`;
  });
</script>

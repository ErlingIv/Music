<!doctype html>
<meta charset="utf-8">
<title>Composers</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:1100px;margin:2rem auto;padding:0 1rem;line-height:1.45}
  header{display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap}
  h1{margin:.2rem 0}
  .muted{color:#666}
  .msg{padding:1rem;border:1px solid #e0e0e0;border-radius:10px;background:#fafafa}
  .composer{margin:1rem 0 1.25rem;border-top:1px solid #eee;padding-top:.9rem}
  .composer h3{margin:.2rem 0 .2rem;font-size:1.15rem}
  .composer h3 a{color:inherit;text-decoration:none;border-bottom:1px dashed #999}
  .composer h3 a:hover{text-decoration:underline}
  ul.works{padding-left:1.25rem;margin:.4rem 0}
  li.work{margin:.35rem 0}
  nav.alpha{margin:.5rem 0 0}
  nav.alpha a{margin-right:.35rem;text-decoration:none;border:1px solid #e1e1e1;border-radius:8px;padding:.1rem .4rem;color:inherit}
  nav.alpha a.active{border-color:#0b5fff}
  .topnav a{margin-right:.75rem}
</style>

<header>
  <div>
    <h1 id="title">Composers</h1>
    <div class="muted" id="subtitle"></div>
  </div>
  <div class="topnav">
    <a href="index.html">← Home</a>
    <a href="composers.html">A–Å index</a>
  </div>
</header>

<nav class="alpha" id="alpha"></nav>

<div id="out" class="msg">Loading…</div>
<div id="host"></div>

<script>
const LETTERS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Æ","Ø","Å"];
const collator = new Intl.Collator("nb",{sensitivity:"base"});
const params = new URLSearchParams(location.search);
let L = params.get("L") || "A";
if(!LETTERS.includes(L)) L = "A";
document.getElementById("title").textContent = `Composers — ${L}`;
document.getElementById("subtitle").textContent = "Sorted by surname (A–Å). Click composer or work to open links.";
document.getElementById('alpha').innerHTML = LETTERS.map(ch =>
  `<a class="${ch===L?'active':''}" href="?L=${encodeURIComponent(ch)}">${ch}</a>`).join(' ');

const OUT = document.getElementById('out');
const HOST = document.getElementById('host');

const clean = v => (v==null ? "" : String(v).trim());
const surname = n => {
  let s = clean(n);
  if(!s) return "";
  if(s.includes(",")) return s.split(",")[0].trim();
  const parts = s.split(/\s+/);
  return parts[parts.length-1] || s;
};

function normalizeForLetter(json, letter){
  // Your JSON shape: { "A":[ { name, url, birth, death, works:[ {title,url,year,lyr,lyrUrl,comments} ] }, ... ], "B":[...], ... }
  const arr = Array.isArray(json?.[letter]) ? json[letter] : [];
  // sanitize odd "nan" strings if any
  const fix = v => (clean(v).toLowerCase()==="nan" ? "" : clean(v));

  return arr.map(c=>{
    const name = fix(c.name);
    const life = (fix(c.birth) || fix(c.death)) ? ` ${fix(c.birth)}–${fix(c.death)}`.replace("–","–").replace(/^ \–/," –") : "";
    const url  = fix(c.url);
    const works = Array.isArray(c.works) ? c.works.map(w=>{
      const wtitle = fix(w.title);
      return {
        title: wtitle,
        url: fix(w.url),                 // <-- clickable score link
        year: fix(w.year),
        lyr: fix(w.lyr),                 // text incl. years (already formatted)
        lyrUrl: fix(w.lyrUrl),           // <-- clickable lyricist link
        comments: fix(w.comments)
      };
    }) : [];
    return { name, life, url, works };
  }).filter(c=>c.name && c.works.length);
}

fetch('data/composers.json?nocache='+Date.now(), {cache:'no-store'})
  .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
  .then(t=>JSON.parse(t.replace(/^\uFEFF/,'')))
  .then(json=>{
    const comps = normalizeForLetter(json, L);
    if(!comps.length){
      OUT.className='msg';
      OUT.innerHTML = `No composers for <strong>${L}</strong>.`;
      return;
    }

    // sort composers by surname, then full name
    comps.sort((a,b)=>{
      const sa = surname(a.name), sb = surname(b.name);
      const s = collator.compare(sa, sb);
      return s || collator.compare(a.name, b.name);
    });
    // sort works by year then title
    comps.forEach(c=>{
      c.works.sort((x,y)=>{
        const ax = parseInt(x.year)||0, ay = parseInt(y.year)||0;
        if(ax !== ay) return ax - ay;
        return collator.compare(x.title, y.title);
      });
    });

    OUT.textContent = ""; // clear loading

    HOST.innerHTML = comps.map(c=>{
      const nameHTML = c.url
        ? `<a href="${c.url}" target="_blank" rel="noopener">${c.name}</a>`
        : c.name;
      const lifeHTML = c.life ? ` <span class="muted">— ${c.life.replace(/^ /,'')}</span>` : "";

      const worksHTML = c.works.map(w=>{
        const yr = w.year ? ` (${w.year})` : "";
        const titleHTML = w.url
          ? `<a href="${w.url}" target="_blank" rel="noopener"><strong>${w.title}</strong></a>`
          : `<strong>${w.title}</strong>`;
        const lyrHTML = w.lyr
          ? (w.lyrUrl
              ? `<a href="${w.lyrUrl}" target="_blank" rel="noopener">${w.lyr}</a>`
              : `${w.lyr}`)
          : "";
        const lyrLine = lyrHTML ? `<div class="muted">Lyricist: ${lyrHTML}</div>` : "";
        const notes = w.comments ? `<div class="muted">${w.comments}</div>` : "";
        return `<li class="work">${titleHTML}${yr}${lyrLine}${notes}</li>`;
      }).join("");

      return `<article class="composer">
        <h3>${nameHTML}${lifeHTML}</h3>
        <ul class="works">${worksHTML}</ul>
      </article>`;
    }).join("");
  })
  .catch(err=>{
    OUT.className='msg';
    OUT.innerHTML = `Error loading <code>data/composers.json</code>: ${err.message}`;
  });
</script>

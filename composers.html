<!doctype html>
<meta charset="utf-8">
<title>Composers</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:1000px;margin:2rem auto;padding:0 1rem;line-height:1.45}
  h1{margin:.2rem 0 1rem}
  .msg{padding:1rem;border:1px solid #e0e0e0;border-radius:10px;background:#fafafa;color:#333}
  ul{padding-left:1.25rem}
  li{margin:.3rem 0}
  .muted{color:#666}
  .group{margin-top:1.2rem;border-top:1px solid #eee;padding-top:.8rem}
</style>
<h1>Composers</h1>
<div id="out" class="msg">Loading…</div>
<div id="host"></div>

<script>
const OUT = document.getElementById('out');
const HOST = document.getElementById('host');

// helper: safe get with Norwegian/English variants
function pick(obj, keys){
  for(const k of keys){ if(obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k]; }
  return "";
}
// initial (surname) from last token
function initial(name){
  if(!name) return "#";
  let n = String(name).trim();
  if(n.includes(",")) n = n.split(",")[0].trim();
  const parts = n.split(/\s+/); const s = parts[parts.length-1] || n;
  const f = s[0].toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
  return ["Æ","Ø","Å"].includes(s[0].toUpperCase()) ? s[0].toUpperCase()
       : /[A-Z]/.test(f) ? f : "#";
}

fetch('data/composers.json?nocache=' + Date.now(), {cache:'no-store'})
  .then(async r=>{
    if(!r.ok) throw new Error("HTTP " + r.status);
    // handle BOM safely
    const text = await r.text();
    const clean = text.replace(/^\uFEFF/,'');
    return JSON.parse(clean);
  })
  .then(json=>{
    // accept array or {works:[…]}
    let arr = Array.isArray(json) ? json
             : (json && Array.isArray(json.works) ? json.works : []);
    if(!Array.isArray(arr)) arr = [];

    if(arr.length === 0){
      OUT.className = "msg";
      OUT.innerHTML = "No items found in <code>data/composers.json</code>. Expected an array or <code>{ works:[…] }</code>.";
      return;
    }

    // normalize each item
    const items = arr.map(it=>{
      const composer = pick(it, ["composer","komponist","name","navn","full name","full_name"]) || "";
      const title    = pick(it, ["title","tittel","work","verk","composition","komposisjon"]) || "";
      let yearRaw    = pick(it, ["year","år","aar","published","composition year","publisert"]);
      let year = "";
      if(yearRaw){
        const m = String(yearRaw).match(/\b(1[6-9]\d{2}|20\d{2})\b/);
        year = m ? m[1] : String(yearRaw);
      }
      const lyricist = pick(it, ["lyricist","tekstforfatter","lyrics","tekst"]);
      const notes    = pick(it, ["notes","kommentar","comments","comment","merknader","notater","anmerkning"]);
      const life     = pick(it, ["life","years","birth–death","birth-death","født–død","fodt–dod","f-d"]);

      return { composer, title, year, lyricist, notes, life };
    });

    // filter out rows missing the two required fields
    const rows = items.filter(x => x.composer && x.title);
    if(rows.length === 0){
      OUT.className = "msg";
      OUT.innerHTML = "Found data, but no entries with both <code>composer</code> and <code>title</code> keys.";
      return;
    }

    // group by initial of surname
    const groups = {};
    rows.forEach(r=>{
      const init = initial(r.composer);
      (groups[init] ||= []).push(r);
    });

    // render
    OUT.textContent = ""; // clear "Loading…"
    const letters = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Æ","Ø","Å"];
    const collator = new Intl.Collator("nb", {sensitivity:"base"});

    HOST.innerHTML = letters.map(L=>{
      const arr = groups[L] || [];
      if(arr.length === 0) return "";
      arr.sort((a,b)=> collator.compare(a.composer, b.composer) || collator.compare(a.title, b.title));
      const itemsHTML = arr.map(x=>{
        const yr = x.year ? ` (${x.year})` : "";
        const life = x.life ? ` <span class="muted">— ${x.life}</span>` : "";
        const lyr = x.lyricist ? `<div class="muted">Lyricist: ${x.lyricist}</div>` : "";
        const notes = x.notes ? `<div class="muted">${String(x.notes)}</div>` : "";
        return `<li><strong>${x.composer}</strong>${life} — ${x.title}${yr}${lyr}${notes}</li>`;
      }).join("");
      return `<section class="group" id="grp-${L}">
        <h2>${L}</h2>
        <ul>${itemsHTML}</ul>
      </section>`;
    }).join("");

    if(!HOST.innerHTML.trim()){
      OUT.className = "msg";
      OUT.textContent = "Data loaded, but no groups to display.";
    }
  })
  .catch(err=>{
    OUT.className = "msg";
    OUT.innerHTML = `Error loading <code>data/composers.json</code>: ${err.message}.<br>
                     Check the file exists at that path and is valid JSON.`;
  });
</script>
